<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>3Dãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ« | ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰STLç”Ÿæˆ (Bambu Labå¯¾å¿œ)</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #ffffff;
      --surface: #f7f7f7;
      --surface2: #eeeeee;
      --border: #dddddd;
      --accent: #d94040;
      --accent-dim: #b83030;
      --success: #2a9d4e;
      --warning: #c47c00;
      --text: #222222;
      --text-dim: #666666;
    }

    body {
      font-family: -apple-system, 'Hiragino Kaku Gothic ProN', 'Yu Gothic UI',
                   'Meiryo', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼ â”€â”€ */
    header {
      background: var(--bg);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      flex-shrink: 0;
    }
    header .logo {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
    }
    header .subtitle {
      font-size: 0.75rem;
      color: var(--text-dim);
    }
    header .badges {
      margin-left: auto;
      display: flex;
      gap: 8px;
    }
    .badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 3px 10px;
      font-size: 0.7rem;
      color: var(--text-dim);
      white-space: nowrap;
    }
    .badge.green { border-color: var(--success); color: var(--success); }

    /* â”€â”€ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ â”€â”€ */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼ â”€â”€ */
    .sidebar {
      width: 320px;
      min-width: 280px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 16px;
      gap: 14px;
    }

    .section-label {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 6px;
    }

    /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
    textarea {
      width: 100%;
      min-height: 110px;
      background: var(--bg);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 0.9rem;
      resize: vertical;
      line-height: 1.6;
      font-family: inherit;
      transition: border-color 0.2s;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* ãƒ’ãƒ³ãƒˆã‚­ãƒ¼ */
    .kbd-hint {
      font-size: 0.7rem;
      color: var(--text-dim);
      text-align: right;
    }
    kbd {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 1px 5px;
      font-size: 0.65rem;
    }

    /* ä¾‹æ–‡ãƒãƒƒãƒ— */
    .examples-wrap { display: flex; flex-wrap: wrap; gap: 6px; }
    .chip {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 10px;
      font-size: 0.72rem;
      color: var(--text-dim);
      cursor: pointer;
      transition: all 0.15s;
      user-select: none;
    }
    .chip:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ãƒœã‚¿ãƒ³ */
    .btn {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .btn-primary {
      background: var(--accent);
      color: white;
    }
    .btn-primary:hover:not(:disabled) { background: var(--accent-dim); }
    .btn-primary:disabled { background: var(--surface2); color: var(--text-dim); cursor: not-allowed; }

    .btn-success {
      background: var(--success);
      color: white;
      display: none;
    }
    .btn-success:hover:not(:disabled) { filter: brightness(1.1); }
    .btn-success:disabled { background: var(--surface2); color: var(--text-dim); cursor: not-allowed; }

    .btn-print {
      background: var(--bg);
      color: var(--text-dim);
      border: 1px solid var(--border);
      display: none;
    }
    .btn-print:hover { border-color: var(--text-dim); color: var(--text); }

    /* STLç”Ÿæˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³è¿‘å‚ï¼‰ */
    .stl-status {
      font-size: 0.78rem;
      text-align: center;
      display: none;
    }
    .stl-status.loading { display: block; color: var(--text-dim); }
    .stl-status.error { display: block; color: var(--accent); }

    /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
    .status {
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 0.82rem;
      line-height: 1.5;
      display: none;
    }
    .status.loading {
      display: block;
      background: var(--surface2);
      color: var(--text-dim);
      animation: pulse 1.5s infinite;
    }
    .status.success {
      display: block;
      background: rgba(42, 157, 78, 0.08);
      border: 1px solid rgba(42, 157, 78, 0.3);
      color: var(--success);
    }
    .status.error {
      display: block;
      background: rgba(217, 64, 64, 0.08);
      border: 1px solid rgba(217, 64, 64, 0.3);
      color: var(--accent);
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* ãƒ¢ãƒ‡ãƒ«æƒ…å ±ãƒ‘ãƒãƒ« */
    .info-panel {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      font-size: 0.82rem;
      display: none;
    }
    .info-panel h3 {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 8px;
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid var(--border);
    }
    .info-row:last-child { border-bottom: none; }
    .info-key { color: var(--text-dim); }
    .info-val { color: var(--text); font-weight: 500; text-align: right; max-width: 60%; word-break: break-word; }

    /* å°åˆ·ãƒãƒ¼ãƒˆ */
    .print-note {
      margin-top: 8px;
      padding: 6px 10px;
      background: rgba(196, 124, 0, 0.08);
      border-left: 3px solid var(--warning);
      border-radius: 4px;
      font-size: 0.78rem;
      color: var(--warning);
      display: none;
    }

    /* ãƒ•ãƒƒã‚¿ãƒ¼ */
    .sidebar-footer {
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      font-size: 0.7rem;
      color: var(--text-dim);
      line-height: 1.7;
    }

    /* â”€â”€ 3Dãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ â”€â”€ */
    .viewer-wrap {
      flex: 1;
      position: relative;
      overflow: hidden;
      background: #f5f5f5;
    }
    #viewer-canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    /* ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ä¸Šã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .viewer-overlay {
      position: absolute;
      top: 12px;
      right: 14px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      pointer-events: none;
    }
    .overlay-badge {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 10px;
      font-size: 0.7rem;
      color: var(--text-dim);
      backdrop-filter: blur(4px);
    }

    /* ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ä¸­å¤®ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ */
    .viewer-placeholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 12px;
      pointer-events: none;
    }
    .placeholder-icon {
      font-size: 4rem;
      opacity: 0.2;
    }
    .placeholder-text {
      font-size: 0.85rem;
      color: var(--text-dim);
      opacity: 0.6;
    }

    /* ã‚¹ãƒ”ãƒŠãƒ¼ */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ èª¿æ•´ãƒ‘ãƒãƒ« â”€â”€ */
    .adjust-panel {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      display: none;
    }
    .adjust-panel h3 {
      font-size: 0.7rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      color: var(--text-dim);
      margin-bottom: 10px;
    }

    /* ç„¡å¢/ä¸­ç©ºãƒˆã‚°ãƒ« */
    .hollow-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }
    .hollow-label { font-size: 0.78rem; color: var(--text-dim); flex-shrink: 0; }
    .toggle-group {
      display: flex;
      border: 1px solid var(--border);
      border-radius: 4px;
      overflow: hidden;
    }
    .toggle-btn {
      border: none;
      background: var(--bg);
      color: var(--text-dim);
      padding: 4px 14px;
      font-size: 0.78rem;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .toggle-btn.active { background: var(--accent); color: white; }

    /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
    .slider-row {
      display: grid;
      grid-template-columns: 76px 1fr 38px;
      align-items: center;
      gap: 8px;
      margin-bottom: 7px;
    }
    .slider-row label {
      font-size: 0.74rem;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .slider-row input[type=range] {
      width: 100%;
      accent-color: var(--accent);
      cursor: pointer;
      height: 4px;
    }
    .slider-val {
      font-size: 0.74rem;
      color: var(--text);
      text-align: right;
      white-space: nowrap;
    }

    /* â”€â”€ å°åˆ·ã‚¹ã‚¿ã‚¤ãƒ« â”€â”€ */
    .print-info { display: none; }

    @media print {
      @page {
        size: A4;
        margin: 15mm;
      }

      body {
        height: auto;
        overflow: visible;
        background: white;
      }

      header .badges { display: none; }
      .sidebar { display: none; }

      .layout {
        display: block;
        overflow: visible;
      }

      .viewer-wrap {
        width: var(--print-width, 100mm);
        height: var(--print-height, 100mm);
        overflow: visible;
        background: white;
      }

      #viewer-canvas {
        width: var(--print-width, 100mm) !important;
        height: var(--print-height, 100mm) !important;
      }

      .viewer-overlay { display: none; }
      .viewer-placeholder { display: none; }

      .print-info {
        display: block !important;
        margin-top: 6mm;
        font-size: 9pt;
        color: #444;
        border-top: 0.5pt solid #ccc;
        padding-top: 3mm;
      }
    }
  </style>
</head>
<body>

<header>
  <div>
    <div class="logo">3Dãƒ‡ã‚¶ã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«</div>
    <div class="subtitle">ãƒ†ã‚­ã‚¹ãƒˆè¨˜è¿°ã‹ã‚‰3Dãƒ¢ãƒ‡ãƒ«ã®STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ</div>
  </div>
  <div class="badges">
    <span class="badge green">Bambu Lab mini å¯¾å¿œ</span>
    <span class="badge">Ollama AI æ­è¼‰</span>
  </div>
</header>

<div class="layout">

  <!-- â”€â”€ ã‚µã‚¤ãƒ‰ãƒãƒ¼ â”€â”€ -->
  <aside class="sidebar">

    <div>
      <div class="section-label">3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’èª¬æ˜ã™ã‚‹</div>
      <textarea
        id="textInput"
        placeholder="ä¾‹: é«˜ã•8cmã€ç›´å¾„5cmã®å††æŸ±å½¢ã®ãƒšãƒ³ç«‹ã¦ã‚’ä½œã£ã¦"
        autocomplete="off"
        spellcheck="false"
      ></textarea>
      <div class="kbd-hint"><kbd>Ctrl</kbd>+<kbd>Enter</kbd> ã§ç”Ÿæˆ</div>
    </div>

    <div>
      <div class="section-label">ä¾‹æ–‡ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦è©¦ã™</div>
      <div class="examples-wrap">
        <span class="chip" data-text="é«˜ã•80mmã€ç›´å¾„50mmã®å††æŸ±">å††æŸ±</span>
        <span class="chip" data-text="ä¸€è¾º40mmã®ç«‹æ–¹ä½“">ç«‹æ–¹ä½“</span>
        <span class="chip" data-text="åŠå¾„30mmã®çƒä½“">çƒä½“</span>
        <span class="chip" data-text="åº•é¢åŠå¾„40mmã€é«˜ã•70mmã®å††éŒ">å††éŒ</span>
        <span class="chip" data-text="å¤–å¾„40mmã€ç®¡å¾„10mmã®ãƒˆãƒ¼ãƒ©ã‚¹ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„å½¢ï¼‰">ãƒ‰ãƒ¼ãƒŠãƒ„</span>
        <span class="chip" data-text="åŠå¾„12mmã€é«˜ã•60mmã®ã‚«ãƒ—ã‚»ãƒ«å½¢çŠ¶">ã‚«ãƒ—ã‚»ãƒ«</span>
        <span class="chip" data-text="åº•é¢ä¸€è¾º50mmã€é«˜ã•60mmã®ãƒ”ãƒ©ãƒŸãƒƒãƒ‰">ãƒ”ãƒ©ãƒŸãƒƒãƒ‰</span>
        <span class="chip" data-text="å¹…120mmã€å¥¥è¡Œã80mmã€é«˜ã•15mmã®è–„ã„ç›´æ–¹ä½“ï¼ˆã‚¹ãƒãƒ›ã‚¹ã‚¿ãƒ³ãƒ‰ã®å°åº§ï¼‰">ã‚¹ãƒãƒ›å°åº§</span>
        <span class="chip" data-text="ç›´å¾„6cmã€é«˜ã•10cmã®å††æŸ±å½¢ã®èŠ±ç“¶ï¼ˆBambu Lab miniã§å°åˆ·ã—ãŸã„ï¼‰">èŠ±ç“¶</span>
        <span class="chip" data-text="å¹…50mmã€å¥¥è¡Œã30mmã€é«˜ã•20mmã®ååˆºå…¥ã‚Œå‹ã®ç®±">ååˆºå…¥ã‚Œ</span>
      </div>
    </div>

    <button class="btn btn-primary" id="previewBtn" onclick="handlePreview()">
      3Dãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆ
    </button>

    <div class="status" id="status"></div>

    <div class="info-panel" id="infoPanel">
      <h3>ç”Ÿæˆã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«æƒ…å ±</h3>
      <div id="infoRows"></div>
      <div class="print-note" id="printNote"></div>
    </div>

    <!-- â”€â”€ èª¿æ•´ãƒ‘ãƒãƒ« â”€â”€ -->
    <div class="adjust-panel" id="adjustPanel">
      <h3>å½¢çŠ¶ã‚’èª¿æ•´</h3>
      <div class="hollow-row">
        <span class="hollow-label">ç´ æ</span>
        <div class="toggle-group">
          <button class="toggle-btn active" id="solidBtn" onclick="setHollowMode(false)">ç„¡å¢</button>
          <button class="toggle-btn"        id="hollowBtn" onclick="setHollowMode(true)">ä¸­ç©º</button>
        </div>
      </div>
      <div id="paramSliders"></div>
    </div>

    <button class="btn btn-success" id="exportBtn" onclick="handleExport()">
      STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>

    <div class="stl-status" id="stlStatus"></div>

    <button class="btn btn-print" id="printBtn" onclick="handlePrint()">
      å®Ÿå¯¸ã§å°åˆ·ã™ã‚‹
    </button>

    <div class="sidebar-footer">
      <strong>3Dãƒ“ãƒ¥ãƒ¼æ“ä½œ</strong><br>
      ãƒ‰ãƒ©ãƒƒã‚°: å›è»¢ ï¼ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«: ã‚ºãƒ¼ãƒ  ï¼ å³ãƒ‰ãƒ©ãƒƒã‚°: ç§»å‹•<br><br>
      <strong>Bambu Lab mini æœ€å¤§é€ å½¢ã‚µã‚¤ã‚º</strong><br>
      180 Ã— 180 Ã— 180 mm<br><br>
      ç”Ÿæˆã—ãŸ .stl ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ Bambu Studio ã§é–‹ã„ã¦ã‚¹ãƒ©ã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚
    </div>

  </aside>

  <!-- â”€â”€ 3Dãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ â”€â”€ -->
  <div class="viewer-wrap">
    <canvas id="viewer-canvas"></canvas>

    <div class="viewer-placeholder" id="placeholder">
      <div class="placeholder-icon">ğŸ“¦</div>
      <div class="placeholder-text">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦3Dãƒ¢ãƒ‡ãƒ«ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
    </div>

    <div class="viewer-overlay">
      <div class="overlay-badge" id="modelSize" style="display:none"></div>
      <div class="overlay-badge">ãƒã‚¦ã‚¹ã§è¦–ç‚¹å¤‰æ›´</div>
    </div>

    <!-- å°åˆ·æ™‚ã®ã¿è¡¨ç¤ºã™ã‚‹å¯¸æ³•æƒ…å ± -->
    <div class="print-info" id="printInfo"></div>
  </div>

</div>

<!-- â”€â”€ Three.js (ESM) â”€â”€ -->
<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from "three";
import { STLLoader } from "three/addons/loaders/STLLoader.js";
import { OrbitControls } from "three/addons/controls/OrbitControls.js";

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Three.js åˆæœŸåŒ–
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const canvas = document.getElementById("viewer-canvas");
const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.shadowMap.enabled = true;
renderer.shadowMap.type = THREE.PCFSoftShadowMap;

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xf5f5f5);

const camera = new THREE.PerspectiveCamera(45, 1, 0.1, 10000);
camera.position.set(120, 90, 120);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.dampingFactor = 0.08;
controls.minDistance = 5;
controls.maxDistance = 2000;

// â”€â”€ ãƒ©ã‚¤ãƒˆ â”€â”€
scene.add(new THREE.AmbientLight(0xffffff, 0.9));

const dirLight = new THREE.DirectionalLight(0xffffff, 1.0);
dirLight.position.set(150, 200, 100);
dirLight.castShadow = true;
dirLight.shadow.mapSize.set(2048, 2048);
dirLight.shadow.camera.near = 1;
dirLight.shadow.camera.far = 1000;
dirLight.shadow.camera.left = -200;
dirLight.shadow.camera.right = 200;
dirLight.shadow.camera.top = 200;
dirLight.shadow.camera.bottom = -200;
scene.add(dirLight);

const fillLight = new THREE.DirectionalLight(0x8888ff, 0.2);
fillLight.position.set(-100, 50, -100);
scene.add(fillLight);

// â”€â”€ ã‚°ãƒªãƒƒãƒ‰ â”€â”€
const grid = new THREE.GridHelper(400, 40, 0xcccccc, 0xe0e0e0);
grid.receiveShadow = true;
scene.add(grid);

// â”€â”€ å½±å—ã‘ãƒ—ãƒ¬ãƒ¼ãƒ³ â”€â”€
const shadowPlane = new THREE.Mesh(
  new THREE.PlaneGeometry(600, 600),
  new THREE.ShadowMaterial({ opacity: 0.1 })
);
shadowPlane.rotation.x = -Math.PI / 2;
shadowPlane.position.y = -0.1;
shadowPlane.receiveShadow = true;
scene.add(shadowPlane);

// â”€â”€ ãƒªã‚µã‚¤ã‚º â”€â”€
function resize() {
  const w = canvas.parentElement.clientWidth;
  const h = canvas.parentElement.clientHeight;
  renderer.setSize(w, h);
  camera.aspect = w / h;
  camera.updateProjectionMatrix();
}
window.addEventListener("resize", resize);
resize();

// â”€â”€ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— â”€â”€
function animate() {
  requestAnimationFrame(animate);
  controls.update();
  renderer.render(scene, camera);
}
animate();

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STL ãƒ­ãƒ¼ãƒ€ãƒ¼
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loader = new STLLoader();
let currentMesh = null;
let modelSizeMm = null; // { x, y, z } mmå˜ä½

window.loadSTLFromBase64 = function (base64Data) {
  const binary = atob(base64Data);
  const bytes = new Uint8Array(binary.length);
  for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);

  const geometry = loader.parse(bytes.buffer);
  geometry.computeVertexNormals();

  if (currentMesh) {
    scene.remove(currentMesh);
    currentMesh.geometry.dispose();
    currentMesh.material.dispose();
    currentMesh = null;
  }

  const material = new THREE.MeshStandardMaterial({
    color: 0xd94040,
    roughness: 0.4,
    metalness: 0.1,
    side: THREE.DoubleSide,
  });

  currentMesh = new THREE.Mesh(geometry, material);
  currentMesh.castShadow = true;
  currentMesh.receiveShadow = true;

  geometry.computeBoundingBox();
  const bbox = geometry.boundingBox;
  const center = new THREE.Vector3();
  bbox.getCenter(center);
  const size = new THREE.Vector3();
  bbox.getSize(size);

  // STLã®å˜ä½ã¯mm â†’ ãã®ã¾ã¾mmå¯¸æ³•ã¨ã—ã¦è¨˜éŒ²
  modelSizeMm = { x: size.x, y: size.y, z: size.z };

  currentMesh.position.set(-center.x, -bbox.min.y, -center.z);
  scene.add(currentMesh);

  grid.position.y = 0;

  const maxDim = Math.max(size.x, size.y, size.z);
  const dist = maxDim * 2.2;
  camera.position.set(dist, dist * 0.7, dist);
  controls.target.set(0, size.y / 2, 0);
  controls.update();

  document.getElementById("placeholder").style.display = "none";

  const sizeEl = document.getElementById("modelSize");
  sizeEl.style.display = "block";
  sizeEl.textContent = `${size.x.toFixed(1)} Ã— ${size.y.toFixed(1)} Ã— ${size.z.toFixed(1)} mm`;
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// å°åˆ·å‡¦ç†ï¼ˆå®Ÿå¯¸ãƒ»çœŸä¸Šã‹ã‚‰ï¼‰
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handlePrint = function () {
  window.print();
};

window.addEventListener("beforeprint", () => {
  if (!currentMesh || !modelSizeMm) return;

  const { x: w, z: d, y: h } = modelSizeMm; // å¹…ãƒ»å¥¥è¡Œããƒ»é«˜ã• (mm)

  // CSSå¤‰æ•°ã§canvasã®å°åˆ·ã‚µã‚¤ã‚ºã‚’å®Ÿå¯¸æŒ‡å®š
  document.documentElement.style.setProperty("--print-width", `${w}mm`);
  document.documentElement.style.setProperty("--print-height", `${d}mm`);

  // å°åˆ·æƒ…å ±ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå®Ÿå¯¸è¡¨è¨˜ï¼‰
  document.getElementById("printInfo").textContent =
    `å®Ÿå¯¸ãƒ»çœŸä¸Šã‹ã‚‰è¡¨ç¤º â€• å¹… ${w.toFixed(1)} mm Ã— å¥¥è¡Œã ${d.toFixed(1)} mm Ã— é«˜ã• ${h.toFixed(1)} mm`;

  // ç›´äº¤æŠ•å½±ã‚«ãƒ¡ãƒ©ã§çœŸä¸Šã‹ã‚‰æç”»ï¼ˆ1mm = 1mmã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
  const PX_PER_MM = 96 / 25.4; // 96 dpi åŸºæº–
  const pw = Math.round(w * PX_PER_MM);
  const ph = Math.round(d * PX_PER_MM);

  renderer.setPixelRatio(1);
  renderer.setSize(pw, ph);

  scene.background = new THREE.Color(0xffffff);
  grid.visible = false;

  const orthoCamera = new THREE.OrthographicCamera(
    -w / 2, w / 2,
    d / 2, -d / 2,
    -1000, 1000
  );
  orthoCamera.position.set(0, 500, 0);
  orthoCamera.lookAt(0, 0, 0);
  orthoCamera.up.set(0, 0, -1);

  renderer.render(scene, orthoCamera);
});

window.addEventListener("afterprint", () => {
  // é€šå¸¸è¡¨ç¤ºã«æˆ»ã™
  scene.background = new THREE.Color(0xf5f5f5);
  grid.visible = true;
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  resize();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// UI ãƒ­ã‚¸ãƒƒã‚¯
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ä¾‹æ–‡ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯
document.querySelectorAll(".chip").forEach((chip) => {
  chip.addEventListener("click", () => {
    document.getElementById("textInput").value = chip.dataset.text;
    document.getElementById("textInput").focus();
  });
});

// Ctrl+Enter ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ
document.getElementById("textInput").addEventListener("keydown", (e) => {
  if (e.ctrlKey && e.key === "Enter") {
    e.preventDefault();
    window.handlePreview();
  }
});

// ç¾åœ¨ã®ãƒ¢ãƒ‡ãƒ«ã® shape_paramsï¼ˆSTLç”Ÿæˆã«ä½¿ç”¨ï¼‰
let currentShapeParams = null;

// â”€â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handlePreview = async function () {
  const text = document.getElementById("textInput").value.trim();
  if (!text) {
    alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  const btn = document.getElementById("previewBtn");
  const status = document.getElementById("status");
  const infoPanel = document.getElementById("infoPanel");
  const exportBtn = document.getElementById("exportBtn");
  const stlStatus = document.getElementById("stlStatus");
  const printBtn = document.getElementById("printBtn");

  // ãƒªã‚»ãƒƒãƒˆ
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>ç”Ÿæˆä¸­...';
  status.className = "status loading";
  status.innerHTML = '<span class="spinner"></span>AIãŒãƒ†ã‚­ã‚¹ãƒˆã‚’è§£æã—ã¦3Dãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆä¸­...';
  infoPanel.style.display = "none";
  document.getElementById("adjustPanel").style.display = "none";
  exportBtn.style.display = "none";
  stlStatus.className = "stl-status";
  printBtn.style.display = "none";
  currentShapeParams = null;

  try {
    const res = await fetch("/api/preview", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ text }),
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      throw new Error(data.error || "ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }

    // ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ã«ãƒ­ãƒ¼ãƒ‰
    window.loadSTLFromBase64(data.stl_base64);

    // shape_params ã‚’ä¿å­˜ï¼ˆSTLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã§ä½¿ç”¨ï¼‰
    currentShapeParams = data.shape_params;

    // ãƒ¢ãƒ‡ãƒ«æƒ…å ±ãƒ‘ãƒãƒ«
    const params = data.shape_params;
    const dims = params.dimensions || {};
    const rows = [
      ["å½¢çŠ¶", shapeLabel(params.shape)],
      ["èª¬æ˜", params.description || "-"],
      ...Object.entries(dims).map(([k, v]) => [dimLabel(k), `${v} mm`]),
    ];

    document.getElementById("infoRows").innerHTML = rows
      .map(([k, v]) => `
        <div class="info-row">
          <span class="info-key">${escHtml(k)}</span>
          <span class="info-val">${escHtml(String(v))}</span>
        </div>`)
      .join("");

    const printNote = document.getElementById("printNote");
    if (params.print_notes) {
      printNote.style.display = "block";
      printNote.textContent = "âš  " + params.print_notes;
    } else {
      printNote.style.display = "none";
    }

    infoPanel.style.display = "block";
    buildAdjustPanel(data.shape_params);
    exportBtn.style.display = "block";
    printBtn.style.display = "block";

    status.className = "status success";
    status.textContent = "âœ“ 3Dãƒ¢ãƒ‡ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å½¢çŠ¶ã‚’èª¿æ•´ã§ãã¾ã™ã€‚";
  } catch (err) {
    status.className = "status error";
    status.textContent = "âœ• ã‚¨ãƒ©ãƒ¼: " + err.message;
  } finally {
    btn.disabled = false;
    btn.textContent = "3Dãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆ";
  }
};

// â”€â”€ STLã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.handleExport = async function () {
  if (!currentShapeParams) return;

  const exportBtn = document.getElementById("exportBtn");
  const stlStatus = document.getElementById("stlStatus");

  const rawText = document.getElementById("textInput").value.trim();
  const safeText = rawText.slice(0, 30).replace(/[^\w\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/g, "_");
  const filename = (safeText || "model") + ".stl";

  exportBtn.disabled = true;
  exportBtn.innerHTML = '<span class="spinner"></span>STLã‚’ç”Ÿæˆä¸­...';
  stlStatus.className = "stl-status";

  try {
    const res = await fetch("/api/export", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shape_params: currentShapeParams, filename }),
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.error || "STLã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
    }

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  } catch (err) {
    stlStatus.className = "stl-status error";
    stlStatus.textContent = "âœ• " + err.message;
  } finally {
    exportBtn.disabled = false;
    exportBtn.textContent = "STLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰";
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// èª¿æ•´ãƒ‘ãƒãƒ«
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ç¾åœ¨ã®èª¿æ•´ä¸­ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆdeep copyï¼‰
let adjustParams = null;
let refreshTimer = null;

// ä¸­ç©ºå¯¾å¿œå½¢çŠ¶ï¼ˆã“ã‚Œä»¥å¤–ã¯ãƒˆã‚°ãƒ«ã‚’ç„¡åŠ¹åŒ–ï¼‰
const HOLLOW_SHAPES = new Set([
  "box","cube","ç›´æ–¹ä½“","ç«‹æ–¹ä½“","rectangular","rectangle",
  "cylinder","å††æŸ±","ã‚·ãƒªãƒ³ãƒ€ãƒ¼","tube",
  "vase","èŠ±ç“¶","bottle","jar","bowl","ãƒœã‚¦ãƒ«","çš¿","dish",
  "pipe","hollow_cylinder","ãƒ‘ã‚¤ãƒ—",
]);

function buildAdjustPanel(shapeParams) {
  adjustParams = JSON.parse(JSON.stringify(shapeParams));
  const panel = document.getElementById("adjustPanel");
  const slidersDiv = document.getElementById("paramSliders");
  panel.style.display = "block";
  slidersDiv.innerHTML = "";

  // ç„¡å¢/ä¸­ç©ºã®åˆæœŸçŠ¶æ…‹
  const dims = adjustParams.dimensions || {};
  const hasWall = "wall_thickness" in dims || "wall" in dims;
  _syncHollowUI(hasWall);

  // ä¸­ç©ºéå¯¾å¿œå½¢çŠ¶ã¯ãƒˆã‚°ãƒ«ã‚’æ·¡è‰²ã«
  const shape = (adjustParams.shape || "").toLowerCase();
  const hollowOk = HOLLOW_SHAPES.has(shape);
  document.getElementById("hollowBtn").disabled = !hollowOk;
  document.getElementById("hollowBtn").title = hollowOk ? "" : "ã“ã®å½¢çŠ¶ã¯ä¸­ç©ºã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“";

  // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç”Ÿæˆï¼ˆæ•°å€¤ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ã¿ï¼‰
  const SKIP = new Set(["sections","subdivisions","count"]);
  for (const [key, val] of Object.entries(dims)) {
    if (typeof val !== "number" || SKIP.has(key)) continue;
    _addSliderRow(slidersDiv, key, val);
  }
}

function _addSliderRow(container, key, val) {
  const { min, max, step } = getParamRange(key, val);
  const display = Math.round(val * 10) / 10;
  const row = document.createElement("div");
  row.className = "slider-row";
  row.id = `srow-${key}`;
  row.innerHTML = `
    <label title="${key}">${dimLabel(key)}</label>
    <input type="range" min="${min}" max="${max}" step="${step}" value="${val}"
           data-key="${key}" oninput="onSliderChange(this)">
    <span class="slider-val" id="sv-${key}">${display}</span>`;
  container.appendChild(row);
}

function _syncHollowUI(isHollow) {
  document.getElementById("solidBtn").classList.toggle("active", !isHollow);
  document.getElementById("hollowBtn").classList.toggle("active", isHollow);
}

window.setHollowMode = function (hollow) {
  if (!adjustParams) return;
  const dims = adjustParams.dimensions;
  _syncHollowUI(hollow);

  if (hollow) {
    if (!("wall_thickness" in dims)) {
      const defaultWall = 2.5;
      dims.wall_thickness = defaultWall;
      const slidersDiv = document.getElementById("paramSliders");
      _addSliderRow(slidersDiv, "wall_thickness", defaultWall);
      // å…ˆé ­ã«ç§»å‹•
      const row = document.getElementById("srow-wall_thickness");
      slidersDiv.prepend(row);
    }
  } else {
    delete dims.wall_thickness;
    delete dims.wall;
    const row = document.getElementById("srow-wall_thickness");
    if (row) row.remove();
  }
  scheduleRefresh();
};

window.onSliderChange = function (input) {
  const key = input.dataset.key;
  const val = parseFloat(input.value);
  const display = Math.round(val * 10) / 10;
  const span = document.getElementById("sv-" + key);
  if (span) span.textContent = display;

  if (adjustParams && adjustParams.dimensions) {
    adjustParams.dimensions[key] = val;
  }
  scheduleRefresh();
};

function scheduleRefresh() {
  clearTimeout(refreshTimer);
  refreshTimer = setTimeout(refreshPreview, 320);
}

async function refreshPreview() {
  if (!adjustParams) return;
  try {
    const res = await fetch("/api/render", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ shape_params: adjustParams }),
    });
    const data = await res.json();
    if (data.success) {
      window.loadSTLFromBase64(data.stl_base64);
      // exportBtn ç”¨ã® shape_params ã‚‚æ›´æ–°
      currentShapeParams = JSON.parse(JSON.stringify(adjustParams));
    }
  } catch (_) { /* ã‚µã‚¤ãƒ¬ãƒ³ãƒˆå¤±æ•— */ }
}

function getParamRange(key, currentVal) {
  const table = {
    width: [1,180,1], depth: [1,180,1], height: [1,180,1],
    radius: [1,90,0.5], radius_x: [1,90,0.5], radius_y: [1,90,0.5], radius_z: [1,90,0.5],
    outer_radius: [1,90,0.5], inner_radius: [0.5,85,0.5],
    bottom_radius: [1,90,0.5], top_radius: [1,90,0.5], max_radius: [1,90,0.5],
    major_radius: [1,90,0.5], minor_radius: [0.5,45,0.5],
    base: [1,180,1], wall_thickness: [0.5,20,0.5], wall: [0.5,20,0.5],
    arm1_length: [1,120,1], arm2_length: [1,120,1], arm_length: [1,120,1],
    arm_width: [1,60,0.5], top_length: [1,120,1], stem_length: [1,120,1],
    thickness: [0.5,30,0.5], twist_angle: [0,360,5], angle: [10,360,5],
    amplitude: [0,30,0.5], wave_count: [1,10,1],
    coil_radius: [1,60,0.5], wire_radius: [0.5,20,0.5],
    num_coils: [1,20,1], pitch: [0.5,30,0.5],
    sides: [3,12,1], points: [3,12,1],
    teeth: [6,48,1], module: [0.5,5,0.25], bore_radius: [0,30,0.5],
    egg_radius_xy: [5,60,0.5], egg_height: [5,120,1],
    radius_xy: [5,90,0.5], sphere_radius: [1,60,0.5],
  };
  const entry = table[key];
  if (entry) return { min: entry[0], max: entry[1], step: entry[2] };
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç¾åœ¨å€¤ã® 10% ã€œ 300%
  const lo = Math.max(0.5, Math.round(currentVal * 0.1 * 10) / 10);
  const hi = Math.max(50, Math.round(currentVal * 3));
  const st = currentVal > 20 ? 1 : 0.5;
  return { min: lo, max: hi, step: st };
}

// â”€â”€ ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ â”€â”€
function escHtml(s) {
  return String(s)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

function shapeLabel(shape) {
  const map = {
    box: "ç›´æ–¹ä½“",
    cube: "ç«‹æ–¹ä½“",
    sphere: "çƒä½“",
    cylinder: "å††æŸ±",
    cone: "å††éŒ",
    torus: "ãƒˆãƒ¼ãƒ©ã‚¹",
    capsule: "ã‚«ãƒ—ã‚»ãƒ«",
    pyramid: "ãƒ”ãƒ©ãƒŸãƒƒãƒ‰",
    pipe: "ä¸­ç©ºå††æŸ±",
    hexagonal_prism: "å…­è§’æŸ±",
  };
  return map[shape] || shape;
}

function dimLabel(key) {
  const map = {
    width: "å¹…",
    depth: "å¥¥è¡Œã",
    height: "é«˜ã•",
    radius: "åŠå¾„",
    major_radius: "å¤–å¾„",
    minor_radius: "ç®¡å¾„",
    outer_radius: "å¤–å¾„",
    inner_radius: "å†…å¾„",
    base: "åº•é¢ä¸€è¾º",
    r: "åŠå¾„",
    h: "é«˜ã•",
    w: "å¹…",
    d: "å¥¥è¡Œã",
  };
  return map[key] || key;
}
</script>

</body>
</html>
